name: Update Stock Data

on:
  schedule:
    # Run every weekday at 00:00 UTC (09:00 KST)
    # Note: Collectors handle market holidays gracefully (skip if no data)
    - cron: '0 0 * * 1-5'
  workflow_dispatch:
    inputs:
      market:
        description: 'Market to collect'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - us
          - kr
      test_mode:
        description: 'Run in test mode (few stocks only)'
        required: false
        default: false
        type: boolean

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  collect-us:
    name: Collect US Stocks
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.market == 'all' || github.event.inputs.market == 'us' || github.event_name == 'schedule' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run US stock collector
        id: us_collector
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            uv run --package stock-screener-data-pipeline python -m collectors.us_stocks --test
          else
            uv run --package stock-screener-data-pipeline python -m collectors.us_stocks
          fi

      - name: Summary
        if: always()
        run: |
          echo "## US Stock Collection" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ steps.us_collector.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  collect-kr:
    name: Collect KR Stocks
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.market == 'all' || github.event.inputs.market == 'kr' || github.event_name == 'schedule' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run Korean stock collector
        id: kr_collector
        run: |
          if [ "${{ github.event.inputs.test_mode }}" == "true" ]; then
            uv run --package stock-screener-data-pipeline python -m collectors.kr_stocks --test
          else
            uv run --package stock-screener-data-pipeline python -m collectors.kr_stocks
          fi

      - name: Summary
        if: always()
        run: |
          echo "## KR Stock Collection" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ steps.kr_collector.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [collect-us, collect-kr]
    if: ${{ failure() }}

    steps:
      - name: Create failure summary
        run: |
          echo "## Data Collection Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more collection jobs failed. Please check the logs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
